# 部署指南

## 一、推荐架构

```
┌─────────────────────────────────────────────────────────────┐
│                        云服务器                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  api_server.py                                       │   │
│  │  - AI 内容生成 API                                   │   │
│  │  - 域名: https://your-domain.com                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │ HTTPS API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       用户本地电脑                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  main.py / app.py                                    │   │
│  │  - 浏览器自动化                                       │   │
│  │  - 扫码登录                                          │   │
│  │  - 内容发布                                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 二、云服务器部署步骤

### 2.1 服务器要求

- 操作系统：Ubuntu 20.04+ / CentOS 7+
- 内存：1GB+
- Python 3.8+

### 2.2 安装步骤

```bash
# 1. 克隆代码
git clone <your-repo-url>
cd publish_tools

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 安装依赖（只需要 API 相关的）
pip install flask flask-cors openai

# 4. 测试运行
python api_server.py
```

### 2.3 使用 Gunicorn 生产部署

```bash
# 安装 gunicorn
pip install gunicorn

# 启动服务（4个工作进程）
gunicorn -w 4 -b 0.0.0.0:8080 api_server:app
```

### 2.4 使用 systemd 管理服务

创建 `/etc/systemd/system/publish-api.service`:

```ini
[Unit]
Description=Publish Tools API
After=network.target

[Service]
User=www-data
WorkingDirectory=/path/to/publish_tools
Environment="PATH=/path/to/publish_tools/venv/bin"
ExecStart=/path/to/publish_tools/venv/bin/gunicorn -w 4 -b 0.0.0.0:8080 api_server:app
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable publish-api
sudo systemctl start publish-api
```

### 2.5 Nginx 反向代理（HTTPS）

`/etc/nginx/sites-available/publish-api`:

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

申请 SSL 证书：
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 三、Docker 部署

### 3.1 Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir flask flask-cors openai gunicorn

COPY . .

EXPOSE 8080

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8080", "api_server:app"]
```

### 3.2 构建和运行

```bash
# 构建镜像
docker build -t publish-api .

# 运行容器
docker run -d -p 8080:8080 --name publish-api publish-api
```

### 3.3 docker-compose.yml

```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8080:8080"
    environment:
      - QWEN_API_KEY=sk-eff2128169cc440db8a76dc084bcc8ab
    restart: always
```

## 四、云平台一键部署

### 4.1 Railway

1. 连接 GitHub 仓库
2. 选择 `api_server.py` 作为入口
3. 自动分配域名

### 4.2 Render

1. 创建 Web Service
2. 设置启动命令：`gunicorn -b 0.0.0.0:$PORT api_server:app`

### 4.3 阿里云函数计算 / 腾讯云函数

需要适配 Serverless 格式，适合低频调用场景。

## 五、用户使用方式

### 5.1 修改本地配置

用户下载代码后，修改 `utils/content_generator.py` 中的 API 地址：

```python
# 改为你的服务器地址
API_BASE_URL = "https://your-domain.com/api/generate"
```

或者保持本地直接调用千问 API（当前方式）。

### 5.2 用户运行

```bash
# 本地安装依赖
pip install playwright openai
playwright install chromium

# 运行发布工具
python main.py
```

## 六、安全建议

1. **API 限流**：防止滥用，限制每分钟请求次数
2. **API Key 保护**：不要在代码中硬编码，使用环境变量
3. **用户认证**：如需限制访问，添加 Token 验证
4. **日志记录**：记录请求日志，便于排查问题

### 示例：添加简单 Token 认证

```python
API_TOKEN = os.environ.get('API_TOKEN', 'your-secret-token')

@app.before_request
def check_token():
    if request.endpoint in ['generate_content']:
        token = request.headers.get('Authorization')
        if token != f'Bearer {API_TOKEN}':
            return jsonify({'error': 'Unauthorized'}), 401
```

---

## 七、常见问题

### Q: 能否让用户在网页上直接扫码登录？

A: 技术上可行，但需要：
1. 服务器运行 headless 浏览器
2. 实时截图并通过 WebSocket 推送给前端
3. 为每个用户维护独立的浏览器会话

实现复杂度较高，建议用户在本地运行浏览器部分。

### Q: API 调用会产生费用吗？

A: 是的，通义千问 API 按 token 计费。可以：
1. 设置 API 限流
2. 添加用户额度管理
3. 用户自己提供 API Key

